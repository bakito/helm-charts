name: Add Chart

on:
  release:
    types:
      - published

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          ref: main

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install chart-releaser
        uses: engineerd/configurator@v0.0.8
        with:
          name: cr
          url: https://github.com/helm/chart-releaser/releases/download/v1.2.1/chart-releaser_1.2.1_linux_amd64.tar.gz
          pathInArchive: cr

      - name: Download new Chart
        run: |
          mkdir -p packages
          cd packages
          wget https://github.com/bakito/sandbox-charts/releases/download/${{github.event.release.name }}/${{github.event.release.name }}.tgz
          ls -alh

      - name: Update Helm Index
        run: cr index --config .chart-releaser.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.17

      - name: Generate Readme
        run: go run ./cmd/index2md/ > docs/README.md

      - name: Commit changes
        run: |
          git add .
          git commit -m"add release ${{github.event.release.name }}"
          git push